"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _protocol = require("../../lib/protocol");

var _protocolConverter = _interopRequireWildcard(require("../../lib/jsonwp-proxy/protocol-converter"));

var _chai = _interopRequireDefault(require("chai"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

const {
  MJSONWP,
  W3C
} = _protocol.PROTOCOLS;

_chai.default.use(_chaiAsPromised.default);

describe('Protocol Converter', function () {
  describe('getTimeoutRequestObjects', function () {
    let converter;
    before(function () {
      converter = new _protocolConverter.default(_lodash.default.noop);
    });
    it('should take W3C inputs and produce MJSONWP compatible objects', function () {
      converter.downstreamProtocol = MJSONWP;
      let timeoutObjects = converter.getTimeoutRequestObjects({
        script: 100
      });
      timeoutObjects.length.should.equal(1);
      timeoutObjects[0].should.eql({
        type: 'script',
        ms: 100
      });
    });
    it('should ignore invalid entries while converting from W3C', function () {
      converter.downstreamProtocol = MJSONWP;
      let timeoutObjects = converter.getTimeoutRequestObjects({
        script: 100,
        sessionId: '5432a4f3-cd89-4781-8905-ea9d3150840c',
        bar: -1,
        baz: undefined
      });
      timeoutObjects.length.should.equal(1);
      timeoutObjects[0].should.eql({
        type: 'script',
        ms: 100
      });
    });
    it('should take multiple W3C timeouts and produce multiple MJSONWP compatible objects', function () {
      converter.downstreamProtocol = MJSONWP;
      let [scriptTimeout, pageLoadTimeout, implicitTimeout] = converter.getTimeoutRequestObjects({
        script: 100,
        pageLoad: 200,
        implicit: 300
      });
      scriptTimeout.should.eql({
        type: 'script',
        ms: 100
      });
      pageLoadTimeout.should.eql({
        type: 'page load',
        ms: 200
      });
      implicitTimeout.should.eql({
        type: 'implicit',
        ms: 300
      });
    });
    it('should take MJSONWP input and produce W3C compatible object', function () {
      converter.downstreamProtocol = W3C;
      let timeoutObjects = converter.getTimeoutRequestObjects({
        type: 'implicit',
        ms: 300
      });
      timeoutObjects.length.should.equal(1);
      timeoutObjects[0].should.eql({
        implicit: 300
      });
    });
    it('should not change the input if protocol name is unknown', function () {
      converter.downstreamProtocol = null;
      let timeoutObjects = converter.getTimeoutRequestObjects({
        type: 'implicit',
        ms: 300
      });
      timeoutObjects.length.should.equal(1);
      timeoutObjects[0].should.eql({
        type: 'implicit',
        ms: 300
      });
    });
    it('should not change the input if protocol name is unchanged', function () {
      converter.downstreamProtocol = MJSONWP;
      let timeoutObjects = converter.getTimeoutRequestObjects({
        type: 'implicit',
        ms: 300
      });
      timeoutObjects.length.should.equal(1);
      timeoutObjects[0].should.eql({
        type: 'implicit',
        ms: 300
      });
    });
  });
  describe('setValue', function () {
    let converter;
    let responseBody;
    before(function () {
      responseBody = null;
      converter = new _protocolConverter.default((url, method, body) => {
        responseBody = body;
      });
    });
    beforeEach(function () {
      responseBody = {};
    });
    it('should calculate value if not present', async function () {
      await converter.proxySetValue('', '', {
        text: 'bla'
      });
      responseBody.should.eql({
        text: 'bla',
        value: ['b', 'l', 'a']
      });
    });
    it('should calculate text if not present', async function () {
      await converter.proxySetValue('', '', {
        value: ['b', 'l', 'a']
      });
      responseBody.should.eql({
        text: 'bla',
        value: ['b', 'l', 'a']
      });
    });
    it('should keep the response body unchanged if both value and text are present', async function () {
      await converter.proxySetValue('', '', {
        text: 'bla',
        value: ['b', 'l', 'a']
      });
      responseBody.should.eql({
        text: 'bla',
        value: ['b', 'l', 'a']
      });
    });
  });
  describe('getProperty', function () {
    let jsonwpConverter, w3cConverter;
    before(function () {
      for (let command of _protocolConverter.COMMAND_URLS_CONFLICTS) {
        if (command.commandNames.includes('getProperty')) {
          jsonwpConverter = command.jsonwpConverter;
          w3cConverter = command.w3cConverter;
        }
      }
    });
    it('should convert "property/value" to "attribute/value"', function () {
      jsonwpConverter('/session/123/element/456/property/value').should.equal('/session/123/element/456/attribute/value');
    });
    it('should convert "property/:somePropName" to "attribute/:somePropName"', function () {
      jsonwpConverter('/session/123/element/456/property/somePropName').should.equal('/session/123/element/456/attribute/somePropName');
    });
    it('should not convert from JSONWP to W3C', function () {
      w3cConverter('/session/123/element/456/attribute/someAttr').should.equal('/session/123/element/456/attribute/someAttr');
      w3cConverter('/session/123/element/456/property/someProp').should.equal('/session/123/element/456/property/someProp');
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvanNvbndwLXByb3h5L3Byb3RvY29sLWNvbnZlcnRlci1zcGVjcy5qcyJdLCJuYW1lcyI6WyJNSlNPTldQIiwiVzNDIiwiUFJPVE9DT0xTIiwiY2hhaSIsInVzZSIsImNoYWlBc1Byb21pc2VkIiwiZGVzY3JpYmUiLCJjb252ZXJ0ZXIiLCJiZWZvcmUiLCJQcm90b2NvbENvbnZlcnRlciIsIl8iLCJub29wIiwiaXQiLCJkb3duc3RyZWFtUHJvdG9jb2wiLCJ0aW1lb3V0T2JqZWN0cyIsImdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyIsInNjcmlwdCIsImxlbmd0aCIsInNob3VsZCIsImVxdWFsIiwiZXFsIiwidHlwZSIsIm1zIiwic2Vzc2lvbklkIiwiYmFyIiwiYmF6IiwidW5kZWZpbmVkIiwic2NyaXB0VGltZW91dCIsInBhZ2VMb2FkVGltZW91dCIsImltcGxpY2l0VGltZW91dCIsInBhZ2VMb2FkIiwiaW1wbGljaXQiLCJyZXNwb25zZUJvZHkiLCJ1cmwiLCJtZXRob2QiLCJib2R5IiwiYmVmb3JlRWFjaCIsInByb3h5U2V0VmFsdWUiLCJ0ZXh0IiwidmFsdWUiLCJqc29ud3BDb252ZXJ0ZXIiLCJ3M2NDb252ZXJ0ZXIiLCJjb21tYW5kIiwiQ09NTUFORF9VUkxTX0NPTkZMSUNUUyIsImNvbW1hbmROYW1lcyIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU07QUFBQ0EsRUFBQUEsT0FBRDtBQUFVQyxFQUFBQTtBQUFWLElBQWlCQyxtQkFBdkI7O0FBRUFDLGNBQUtDLEdBQUwsQ0FBU0MsdUJBQVQ7O0FBRUFDLFFBQVEsQ0FBQyxvQkFBRCxFQUF1QixZQUFZO0FBQ3pDQSxFQUFBQSxRQUFRLENBQUMsMEJBQUQsRUFBNkIsWUFBWTtBQUMvQyxRQUFJQyxTQUFKO0FBQ0FDLElBQUFBLE1BQU0sQ0FBQyxZQUFZO0FBQ2pCRCxNQUFBQSxTQUFTLEdBQUcsSUFBSUUsMEJB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QVk7QUFDckY0QixNQUFBQSxlQUFlLENBQUMsZ0RBQUQsQ0FBZixDQUFrRXRCLE1BQWxFLENBQXlFQyxLQUF6RSxDQUErRSxpREFBL0U7QUFDRCxLQUZDLENBQUY7QUFHQVAsSUFBQUEsRUFBRSxDQUFDLHVDQUFELEVBQTBDLFlBQVk7QUFDdEQ2QixNQUFBQSxZQUFZLENBQUMsNkNBQUQsQ0FBWixDQUE0RHZCLE1BQTVELENBQW1FQyxLQUFuRSxDQUF5RSw2Q0FBekU7QUFDQXNCLE1BQUFBLFlBQVksQ0FBQyw0Q0FBRCxDQUFaLENBQTJEdkIsTUFBM0QsQ0FBa0VDLEtBQWxFLENBQXdFLDRDQUF4RTtBQUNELEtBSEMsQ0FBRjtBQUlELEdBcEJPLENBQVI7QUFxQkQsQ0ExSE8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuLyogZ2xvYmFsIGRlc2NyaWJlOnRydWUsIGl0OnRydWUgKi9cblxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFBST1RPQ09MUyB9IGZyb20gJy4uLy4uL2xpYi9wcm90b2NvbCc7XG5pbXBvcnQgUHJvdG9jb2xDb252ZXJ0ZXIsIHtDT01NQU5EX1VSTFNfQ09ORkxJQ1RTfSBmcm9tICcuLi8uLi9saWIvanNvbndwLXByb3h5L3Byb3RvY29sLWNvbnZlcnRlcic7XG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcblxuY29uc3Qge01KU09OV1AsIFczQ30gPSBQUk9UT0NPTFM7XG5cbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuZGVzY3JpYmUoJ1Byb3RvY29sIENvbnZlcnRlcicsIGZ1bmN0aW9uICgpIHtcbiAgZGVzY3JpYmUoJ2dldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cycsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgY29udmVydGVyO1xuICAgIGJlZm9yZShmdW5jdGlvbiAoKSB7XG4gICAgICBjb252ZXJ0ZXIgPSBuZXcgUHJvdG9jb2xDb252ZXJ0ZXIoXy5ub29wKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRha2UgVzNDIGlucHV0cyBhbmQgcHJvZHVjZSBNSlNPTldQIGNvbXBhdGlibGUgb2JqZWN0cycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnZlcnRlci5kb3duc3RyZWFtUHJvdG9jb2wgPSBNSlNPTldQO1xuICAgICAgbGV0IHRpbWVvdXRPYmplY3RzID0gY29udmVydGVyLmdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyh7c2NyaXB0OiAxMDB9KTtcbiAgICAgIHRpbWVvdXRPYmplY3RzLmxlbmd0aC5zaG91bGQuZXF1YWwoMSk7XG4gICAgICB0aW1lb3V0T2JqZWN0c1swXS5zaG91bGQuZXFsKHt0eXBlOiAnc2NyaXB0JywgbXM6IDEwMH0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgaWdub3JlIGludmFsaWQgZW50cmllcyB3aGlsZSBjb252ZXJ0aW5nIGZyb20gVzNDJywgZnVuY3Rpb24gKCkge1xuICAgICAgY29udmVydGVyLmRvd25zdHJlYW1Qcm90b2NvbCA9IE1KU09OV1A7XG4gICAgICBsZXQgdGltZW91dE9iamVjdHMgPSBjb252ZXJ0ZXIuZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzKHtcbiAgICAgICAgc2NyaXB0OiAxMDAsXG4gICAgICAgIHNlc3Npb25JZDogJzU0MzJhNGYzLWNkODktNDc4MS04OTA1LWVhOWQzMTUwODQwYycsXG4gICAgICAgIGJhcjogLTEsXG4gICAgICAgIGJhejogdW5kZWZpbmVkLFxuICAgICAgfSk7XG4gICAgICB0aW1lb3V0T2JqZWN0cy5sZW5ndGguc2hvdWxkLmVxdWFsKDEpO1xuICAgICAgdGltZW91dE9iamVjdHNbMF0uc2hvdWxkLmVxbCh7dHlwZTogJ3NjcmlwdCcsIG1zOiAxMDB9KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRha2UgbXVsdGlwbGUgVzNDIHRpbWVvdXRzIGFuZCBwcm9kdWNlIG11bHRpcGxlIE1KU09OV1AgY29tcGF0aWJsZSBvYmplY3RzJywgZnVuY3Rpb24gKCkge1xuICAgICAgY29udmVydGVyLmRvd25zdHJlYW1Qcm90b2NvbCA9IE1KU09OV1A7XG4gICAgICBsZXQgW3NjcmlwdFRpbWVvdXQsIHBhZ2VMb2FkVGltZW91dCwgaW1wbGljaXRUaW1lb3V0XSA9IGNvbnZlcnRlci5nZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMoe3NjcmlwdDogMTAwLCBwYWdlTG9hZDogMjAwLCBpbXBsaWNpdDogMzAwfSk7XG4gICAgICBzY3JpcHRUaW1lb3V0LnNob3VsZC5lcWwoe1xuICAgICAgICB0eXBlOiAnc2NyaXB0JyxcbiAgICAgICAgbXM6IDEwMCxcbiAgICAgIH0pO1xuICAgICAgcGFnZUxvYWRUaW1lb3V0LnNob3VsZC5lcWwoe1xuICAgICAgICB0eXBlOiAncGFnZSBsb2FkJyxcbiAgICAgICAgbXM6IDIwMCxcbiAgICAgIH0pO1xuICAgICAgaW1wbGljaXRUaW1lb3V0LnNob3VsZC5lcWwoe1xuICAgICAgICB0eXBlOiAnaW1wbGljaXQnLFxuICAgICAgICBtczogMzAwLFxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0YWtlIE1KU09OV1AgaW5wdXQgYW5kIHByb2R1Y2UgVzNDIGNvbXBhdGlibGUgb2JqZWN0JywgZnVuY3Rpb24gKCkge1xuICAgICAgY29udmVydGVyLmRvd25zdHJlYW1Qcm90b2NvbCA9IFczQztcbiAgICAgIGxldCB0aW1lb3V0T2JqZWN0cyA9IGNvbnZlcnRlci5nZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMoe3R5cGU6ICdpbXBsaWNpdCcsIG1zOiAzMDB9KTtcbiAgICAgIHRpbWVvdXRPYmplY3RzLmxlbmd0aC5zaG91bGQuZXF1YWwoMSk7XG4gICAgICB0aW1lb3V0T2JqZWN0c1swXS5zaG91bGQuZXFsKHtpbXBsaWNpdDogMzAwfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgY2hhbmdlIHRoZSBpbnB1dCBpZiBwcm90b2NvbCBuYW1lIGlzIHVua25vd24nLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gbnVsbDtcbiAgICAgIGxldCB0aW1lb3V0T2JqZWN0cyA9IGNvbnZlcnRlci5nZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMoe3R5cGU6ICdpbXBsaWNpdCcsIG1zOiAzMDB9KTtcbiAgICAgIHRpbWVvdXRPYmplY3RzLmxlbmd0aC5zaG91bGQuZXF1YWwoMSk7XG4gICAgICB0aW1lb3V0T2JqZWN0c1swXS5zaG91bGQuZXFsKHt0eXBlOiAnaW1wbGljaXQnLCBtczogMzAwfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBub3QgY2hhbmdlIHRoZSBpbnB1dCBpZiBwcm90b2NvbCBuYW1lIGlzIHVuY2hhbmdlZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnZlcnRlci5kb3duc3RyZWFtUHJvdG9jb2wgPSBNSlNPTldQO1xuICAgICAgbGV0IHRpbWVvdXRPYmplY3RzID0gY29udmVydGVyLmdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyh7dHlwZTogJ2ltcGxpY2l0JywgbXM6IDMwMH0pO1xuICAgICAgdGltZW91dE9iamVjdHMubGVuZ3RoLnNob3VsZC5lcXVhbCgxKTtcbiAgICAgIHRpbWVvdXRPYmplY3RzWzBdLnNob3VsZC5lcWwoe3R5cGU6ICdpbXBsaWNpdCcsIG1zOiAzMDB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NldFZhbHVlJywgZnVuY3Rpb24gKCkge1xuICAgIGxldCBjb252ZXJ0ZXI7XG4gICAgbGV0IHJlc3BvbnNlQm9keTtcbiAgICBiZWZvcmUoZnVuY3Rpb24gKCkge1xuICAgICAgcmVzcG9uc2VCb2R5ID0gbnVsbDtcbiAgICAgIGNvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcigodXJsLCBtZXRob2QsIGJvZHkpID0+IHtcbiAgICAgICAgcmVzcG9uc2VCb2R5ID0gYm9keTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGJlZm9yZUVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgcmVzcG9uc2VCb2R5ID0ge307XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGN1bGF0ZSB2YWx1ZSBpZiBub3QgcHJlc2VudCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGNvbnZlcnRlci5wcm94eVNldFZhbHVlKCcnLCAnJywge1xuICAgICAgICB0ZXh0OiAnYmxhJyxcbiAgICAgIH0pO1xuICAgICAgcmVzcG9uc2VCb2R5LnNob3VsZC5lcWwoe1xuICAgICAgICB0ZXh0OiAnYmxhJyxcbiAgICAgICAgdmFsdWU6IFsnYicsICdsJywgJ2EnXSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgY2FsY3VsYXRlIHRleHQgaWYgbm90IHByZXNlbnQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBjb252ZXJ0ZXIucHJveHlTZXRWYWx1ZSgnJywgJycsIHtcbiAgICAgICAgdmFsdWU6IFsnYicsICdsJywgJ2EnXSxcbiAgICAgIH0pO1xuICAgICAgcmVzcG9uc2VCb2R5LnNob3VsZC5lcWwoe1xuICAgICAgICB0ZXh0OiAnYmxhJyxcbiAgICAgICAgdmFsdWU6IFsnYicsICdsJywgJ2EnXSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQga2VlcCB0aGUgcmVzcG9uc2UgYm9keSB1bmNoYW5nZWQgaWYgYm90aCB2YWx1ZSBhbmQgdGV4dCBhcmUgcHJlc2VudCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGNvbnZlcnRlci5wcm94eVNldFZhbHVlKCcnLCAnJywge1xuICAgICAgICB0ZXh0OiAnYmxhJyxcbiAgICAgICAgdmFsdWU6IFsnYicsICdsJywgJ2EnXSxcbiAgICAgIH0pO1xuICAgICAgcmVzcG9uc2VCb2R5LnNob3VsZC5lcWwoe1xuICAgICAgICB0ZXh0OiAnYmxhJyxcbiAgICAgICAgdmFsdWU6IFsnYicsICdsJywgJ2EnXSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbiAgZGVzY3JpYmUoJ2dldFByb3BlcnR5JywgZnVuY3Rpb24gKCkge1xuICAgIGxldCBqc29ud3BDb252ZXJ0ZXIsIHczY0NvbnZlcnRlcjtcbiAgICBiZWZvcmUoZnVuY3Rpb24gKCkge1xuICAgICAgZm9yIChsZXQgY29tbWFuZCBvZiBDT01NQU5EX1VSTFNfQ09ORkxJQ1RTKSB7XG4gICAgICAgIGlmIChjb21tYW5kLmNvbW1hbmROYW1lcy5pbmNsdWRlcygnZ2V0UHJvcGVydHknKSkge1xuICAgICAgICAgIGpzb253cENvbnZlcnRlciA9IGNvbW1hbmQuanNvbndwQ29udmVydGVyO1xuICAgICAgICAgIHczY0NvbnZlcnRlciA9IGNvbW1hbmQudzNjQ29udmVydGVyO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBjb252ZXJ0IFwicHJvcGVydHkvdmFsdWVcIiB0byBcImF0dHJpYnV0ZS92YWx1ZVwiJywgZnVuY3Rpb24gKCkge1xuICAgICAganNvbndwQ29udmVydGVyKCcvc2Vzc2lvbi8xMjMvZWxlbWVudC80NTYvcHJvcGVydHkvdmFsdWUnKS5zaG91bGQuZXF1YWwoJy9zZXNzaW9uLzEyMy9lbGVtZW50LzQ1Ni9hdHRyaWJ1dGUvdmFsdWUnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGNvbnZlcnQgXCJwcm9wZXJ0eS86c29tZVByb3BOYW1lXCIgdG8gXCJhdHRyaWJ1dGUvOnNvbWVQcm9wTmFtZVwiJywgZnVuY3Rpb24gKCkge1xuICAgICAganNvbndwQ29udmVydGVyKCcvc2Vzc2lvbi8xMjMvZWxlbWVudC80NTYvcHJvcGVydHkvc29tZVByb3BOYW1lJykuc2hvdWxkLmVxdWFsKCcvc2Vzc2lvbi8xMjMvZWxlbWVudC80NTYvYXR0cmlidXRlL3NvbWVQcm9wTmFtZScpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgbm90IGNvbnZlcnQgZnJvbSBKU09OV1AgdG8gVzNDJywgZnVuY3Rpb24gKCkge1xuICAgICAgdzNjQ29udmVydGVyKCcvc2Vzc2lvbi8xMjMvZWxlbWVudC80NTYvYXR0cmlidXRlL3NvbWVBdHRyJykuc2hvdWxkLmVxdWFsKCcvc2Vzc2lvbi8xMjMvZWxlbWVudC80NTYvYXR0cmlidXRlL3NvbWVBdHRyJyk7XG4gICAgICB3M2NDb252ZXJ0ZXIoJy9zZXNzaW9uLzEyMy9lbGVtZW50LzQ1Ni9wcm9wZXJ0eS9zb21lUHJvcCcpLnNob3VsZC5lcXVhbCgnL3Nlc3Npb24vMTIzL2VsZW1lbnQvNDU2L3Byb3BlcnR5L3NvbWVQcm9wJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwiZmlsZSI6InRlc3QvanNvbndwLXByb3h5L3Byb3RvY29sLWNvbnZlcnRlci1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
