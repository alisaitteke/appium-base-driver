"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _ = require("../..");

var _mockRequest = _interopRequireDefault(require("./mock-request"));

var _chai = _interopRequireDefault(require("chai"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

const should = _chai.default.should();

_chai.default.use(_chaiAsPromised.default);

function buildReqRes(url, method, body) {
  let req = {
    originalUrl: url,
    method,
    body
  };
  let res = {};
  res.headers = {};

  res.set = (k, v) => {
    res[k] = v;
  };

  res.status = code => {
    res.sentCode = code;
    return res;
  };

  res.send = body => {
    try {
      body = JSON.parse(body);
    } catch (e) {}

    res.sentBody = body;
  };

  return [req, res];
}

function mockProxy(opts = {}) {
  let proxy = new _.JWProxy(opts);

  proxy.request = async function (...args) {
    return await (0, _mockRequest.default)(...args);
  };

  return proxy;
}

describe('proxy', function () {
  it('should override default params', function () {
    let j = mockProxy({
      server: '127.0.0.2'
    });
    j.server.should.equal('127.0.0.2');
    j.port.should.equal(4444);
  });
  it('should save session id on session creation', async function () {
    let j = mockProxy();
    let [res, body] = await j.proxy('/session', 'POST', {
      desiredCapabilities: {}
    });
    res.statusCode.should.equal(200);
    body.should.eql({
      status: 0,
      sessionId: '123',
      value: {
        browserName: 'boo'
      }
    });
    j.sessionId.should.equal('123');
  });
  describe('getUrlForProxy', function () {
    it('should modify session id, host, and port', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('http://host.com:1234/wd/hub/session/456/element/200/value').should.eql('http://localhost:4444/wd/hub/session/123/element/200/value');
    });
    it('should prepend scheme, host and port if not provided', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('/wd/hub/session/456/element/200/value').should.eql('http://localhost:4444/wd/hub/session/123/element/200/value');
    });
    it('should respect nonstandard incoming request base path', function () {
      let j = mockProxy({
        sessionId: '123',
        reqBasePath: ''
      });
      j.getUrlForProxy('/session/456/element/200/value').should.eql('http://localhost:4444/wd/hub/session/123/element/200/value');
      j = mockProxy({
        sessionId: '123',
        reqBasePath: '/my/base/path'
      });
      j.getUrlForProxy('/my/base/path/session/456/element/200/value').should.eql('http://localhost:4444/wd/hub/session/123/element/200/value');
    });
    it('should work with urls which do not have session ids', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.getUrlForProxy('http://host.com:1234/wd/hub/session').should.eql('http://localhost:4444/wd/hub/session');
      let newUrl = j.getUrlForProxy('/wd/hub/session');
      newUrl.should.eql('http://localhost:4444/wd/hub/session');
    });
    it('should throw an error if url requires a sessionId but its null', function () {
      let j = mockProxy();
      let e;

      try {
        j.getUrlForProxy('/wd/hub/session/456/element/200/value');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('without session id');
    });
    it('should not throw an error if url does not require a session id and its null', function () {
      let j = mockProxy();
      let newUrl = j.getUrlForProxy('/wd/hub/status');
      should.exist(newUrl);
    });
  });
  describe('straight proxy', function () {
    it('should successfully proxy straight', async function () {
      let j = mockProxy();
      let [res, body] = await j.proxy('/status', 'GET');
      res.statusCode.should.equal(200);
      body.should.eql({
        status: 0,
        value: {
          foo: 'bar'
        }
      });
    });
    it('should pass along request errors', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.proxy('/badurl', 'GET').should.eventually.be.rejectedWith('Could not proxy');
    });
    it('should proxy error responses and codes', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [res, body] = await j.proxy('/element/bad/text', 'GET');
      res.statusCode.should.equal(500);
      body.should.eql({
        status: 11,
        value: {
          message: 'Invisible element'
        }
      });
    });
  });
  describe('command proxy', function () {
    it('should successfully proxy command', async function () {
      let j = mockProxy();
      let res = await j.command('/status', 'GET');
      res.should.eql({
        foo: 'bar'
      });
    });
    it('should pass along request errors', function () {
      let j = mockProxy({
        sessionId: '123'
      });
      j.command('/badurl', 'GET').should.eventually.be.rejectedWith('Could not proxy');
    });
    it('should throw when a command fails', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/element/bad/text', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('Invisible element');
    });
    it('should throw when a command fails with a 200 because the status is not 0', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/element/200/text', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.error.should.eql('element not visible');
    });
    it('should throw when a command fails with a 100', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let e = null;

      try {
        await j.command('/session/badchrome/nochrome', 'GET');
      } catch (err) {
        e = err;
      }

      should.exist(e);
      e.message.should.contain('chrome not reachable');
    });
  });
  describe('req/res proxy', function () {
    it('should successfully proxy via req and send to res', async function () {
      let j = mockProxy();
      let [req, res] = buildReqRes('/status', 'GET');
      await j.proxyReqRes(req, res);
      res.headers['content-type'].should.equal('application/json; charset=utf-8');
      res.sentCode.should.equal(200);
      res.sentBody.should.eql({
        status: 0,
        value: {
          foo: 'bar'
        }
      });
    });
    it('should rewrite the inner session id so it doesnt change', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/element/200/value', 'GET');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        status: 0,
        value: 'foobar',
        sessionId: '123'
      });
    });
    it('should rewrite the inner session id with sessionId in url', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/wd/hub/session/456/element/200/value', 'POST');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        status: 0,
        value: 'foobar',
        sessionId: '456'
      });
    });
    it('should pass through urls that do not require session IDs', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/wd/hub/status', 'GET');
      await j.proxyReqRes(req, res);
      res.sentBody.should.eql({
        status: 0,
        value: {
          'foo': 'bar'
        }
      });
    });
    it('should proxy strange responses', async function () {
      let j = mockProxy({
        sessionId: '123'
      });
      let [req, res] = buildReqRes('/nochrome', 'GET');
      await j.proxyReqRes(req, res);
      res.sentCode.should.equal(100);
      res.sentBody.should.eql({
        status: 0,
        value: {
          message: 'chrome not reachable'
        }
      });
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvanNvbndwLXByb3h5L3Byb3h5LXNwZWNzLmpzIl0sIm5hbWVzIjpbInNob3VsZCIsImNoYWkiLCJ1c2UiLCJjaGFpQXNQcm9taXNlZCIsImJ1aWxkUmVxUmVzIiwidXJsIiwibWV0aG9kIiwiYm9keSIsInJlcSIsIm9yaWdpbmFsVXJsIiwicmVzIiwiaGVhZGVycyIsInNldCIsImsiLCJ2Iiwic3RhdHVzIiwiY29kZSIsInNlbnRDb2RlIiwic2VuZCIsIkpTT04iLCJwYXJzZSIsImUiLCJzZW50Qm9keSIsIm1vY2tQcm94eSIsIm9wdHMiLCJwcm94eSIsIkpXUHJveHkiLCJyZXF1ZXN0IiwiYXJncyIsImRlc2NyaWJlIiwiaXQiLCJqIiwic2VydmVyIiwiZXF1YWwiLCJwb3J0IiwiZGVzaXJlZENhcGFiaWxpdGllcyIsInN0YXR1c0NvZGUiLCJlcWwiLCJzZXNzaW9uSWQiLCJ2YWx1ZSIsImJyb3dzZXJOYW1lIiwiZ2V0VXJsRm9yUHJveHkiLCJyZXFCYXNlUGF0aCIsIm5ld1VybCIsImVyciIsImV4aXN0IiwibWVzc2FnZSIsImNvbnRhaW4iLCJmb28iLCJldmVudHVhbGx5IiwiYmUiLCJyZWplY3RlZFdpdGgiLCJjb21tYW5kIiwiZXJyb3IiLCJwcm94eVJlcVJlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsTUFBTSxHQUFHQyxjQUFLRCxNQUFMLEVBQWY7O0FBQ0FDLGNBQUtDLEdBQUwsQ0FBU0MsdUJBQVQ7O0FBRUEsU0FBU0MsV0FBVCxDQUFzQkMsR0FBdEIsRUFBMkJDLE1BQTNCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUN2QyxNQUFJQyxHQUFHLEdBQUc7QUFBQ0MsSUFBQUEsV0FBVyxFQUFFSixHQUFkO0FBQW1CQyxJQUFBQSxNQUFuQjtBQUEyQkMsSUFBQUE7QUFBM0IsR0FBVjtBQUNBLE1BQUlHLEdBQUcsR0FBRyxFQUFWO0FBQ0FBLEVBQUFBLEdBQUcsQ0FBQ0MsT0FBSixHQUFj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b0JpQyxLQUFwQixDQUEwQixHQUExQjtBQUNBdkIsTUFBQUEsR0FBRyxDQUFDWSxRQUFKLENBQWF0QixNQUFiLENBQW9CcUMsR0FBcEIsQ0FBd0I7QUFBQ3RCLFFBQUFBLE1BQU0sRUFBRSxDQUFUO0FBQVl3QixRQUFBQSxLQUFLLEVBQUU7QUFBQ08sVUFBQUEsT0FBTyxFQUFFO0FBQVY7QUFBbkIsT0FBeEI7QUFDRCxLQU5DLENBQUY7QUFPRCxHQWxDTyxDQUFSO0FBbUNELENBNUpPLENBQVIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bW9jaGFcbi8qIGdsb2JhbCBkZXNjcmliZTp0cnVlLCBpdDp0cnVlICovXG5cbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICcuL21vY2stcmVxdWVzdCc7XG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcblxuXG5jb25zdCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBidWlsZFJlcVJlcyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgbGV0IHJlcSA9IHtvcmlnaW5hbFVybDogdXJsLCBtZXRob2QsIGJvZHl9O1xuICBsZXQgcmVzID0ge307XG4gIHJlcy5oZWFkZXJzID0ge307XG4gIHJlcy5zZXQgPSAoaywgdikgPT4geyByZXNba10gPSB2OyB9O1xuICByZXMuc3RhdHVzID0gKGNvZGUpID0+IHtcbiAgICByZXMuc2VudENvZGUgPSBjb2RlO1xuICAgIHJldHVybiByZXM7XG4gIH07XG4gIHJlcy5zZW5kID0gKGJvZHkpID0+IHtcbiAgICB0cnkge1xuICAgICAgYm9keSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgfSBjYXRjaCAoZSkge31cbiAgICByZXMuc2VudEJvZHkgPSBib2R5O1xuICB9O1xuICByZXR1cm4gW3JlcSwgcmVzXTtcbn1cblxuZnVuY3Rpb24gbW9ja1Byb3h5IChvcHRzID0ge30pIHtcbiAgbGV0IHByb3h5ID0gbmV3IEpXUHJveHkob3B0cyk7XG4gIHByb3h5LnJlcXVlc3QgPSBhc3luYyBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgIHJldHVybiBhd2FpdCByZXF1ZXN0KC4uLmFyZ3MpO1xuICB9O1xuICByZXR1cm4gcHJveHk7XG59XG5cbmRlc2NyaWJlKCdwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgaXQoJ3Nob3VsZCBvdmVycmlkZSBkZWZhdWx0IHBhcmFtcycsIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2VydmVyOiAnMTI3LjAuMC4yJ30pO1xuICAgIGouc2VydmVyLnNob3VsZC5lcXVhbCgnMTI3LjAuMC4yJyk7XG4gICAgai5wb3J0LnNob3VsZC5lcXVhbCg0NDQ0KTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc2F2ZSBzZXNzaW9uIGlkIG9uIHNlc3Npb24gY3JlYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGogPSBtb2NrUHJveHkoKTtcbiAgICBsZXQgW3JlcywgYm9keV0gPSBhd2FpdCBqLnByb3h5KCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IHt9fSk7XG4gICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgYm9keS5zaG91bGQuZXFsKHtzdGF0dXM6IDAsIHNlc3Npb25JZDogJzEyMycsIHZhbHVlOiB7YnJvd3Nlck5hbWU6ICdib28nfX0pO1xuICAgIGouc2Vzc2lvbklkLnNob3VsZC5lcXVhbCgnMTIzJyk7XG4gIH0pO1xuICBkZXNjcmliZSgnZ2V0VXJsRm9yUHJveHknLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBtb2RpZnkgc2Vzc2lvbiBpZCwgaG9zdCwgYW5kIHBvcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnaHR0cDovL2hvc3QuY29tOjEyMzQvd2QvaHViL3Nlc3Npb24vNDU2L2VsZW1lbnQvMjAwL3ZhbHVlJylcbiAgICAgICAuc2hvdWxkLmVxbCgnaHR0cDovL2xvY2FsaG9zdDo0NDQ0L3dkL2h1Yi9zZXNzaW9uLzEyMy9lbGVtZW50LzIwMC92YWx1ZScpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJlcGVuZCBzY2hlbWUsIGhvc3QgYW5kIHBvcnQgaWYgbm90IHByb3ZpZGVkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGouZ2V0VXJsRm9yUHJveHkoJy93ZC9odWIvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnKVxuICAgICAgIC5zaG91bGQuZXFsKCdodHRwOi8vbG9jYWxob3N0OjQ0NDQvd2QvaHViL3Nlc3Npb24vMTIzL2VsZW1lbnQvMjAwL3ZhbHVlJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCByZXNwZWN0IG5vbnN0YW5kYXJkIGluY29taW5nIHJlcXVlc3QgYmFzZSBwYXRoJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMycsIHJlcUJhc2VQYXRoOiAnJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnL3Nlc3Npb24vNDU2L2VsZW1lbnQvMjAwL3ZhbHVlJylcbiAgICAgICAuc2hvdWxkLmVxbCgnaHR0cDovL2xvY2FsaG9zdDo0NDQ0L3dkL2h1Yi9zZXNzaW9uLzEyMy9lbGVtZW50LzIwMC92YWx1ZScpO1xuXG4gICAgICBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnLCByZXFCYXNlUGF0aDogJy9teS9iYXNlL3BhdGgnfSk7XG4gICAgICBqLmdldFVybEZvclByb3h5KCcvbXkvYmFzZS9wYXRoL3Nlc3Npb24vNDU2L2VsZW1lbnQvMjAwL3ZhbHVlJylcbiAgICAgICAuc2hvdWxkLmVxbCgnaHR0cDovL2xvY2FsaG9zdDo0NDQ0L3dkL2h1Yi9zZXNzaW9uLzEyMy9lbGVtZW50LzIwMC92YWx1ZScpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIHVybHMgd2hpY2ggZG8gbm90IGhhdmUgc2Vzc2lvbiBpZHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgai5nZXRVcmxGb3JQcm94eSgnaHR0cDovL2hvc3QuY29tOjEyMzQvd2QvaHViL3Nlc3Npb24nKVxuICAgICAgIC5zaG91bGQuZXFsKCdodHRwOi8vbG9jYWxob3N0OjQ0NDQvd2QvaHViL3Nlc3Npb24nKTtcblxuICAgICAgbGV0IG5ld1VybCA9IGouZ2V0VXJsRm9yUHJveHkoJy93ZC9odWIvc2Vzc2lvbicpO1xuICAgICAgbmV3VXJsLnNob3VsZC5lcWwoJ2h0dHA6Ly9sb2NhbGhvc3Q6NDQ0NC93ZC9odWIvc2Vzc2lvbicpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgdXJsIHJlcXVpcmVzIGEgc2Vzc2lvbklkIGJ1dCBpdHMgbnVsbCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgZTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGouZ2V0VXJsRm9yUHJveHkoJy93ZC9odWIvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlID0gZXJyO1xuICAgICAgfVxuICAgICAgc2hvdWxkLmV4aXN0KGUpO1xuICAgICAgZS5tZXNzYWdlLnNob3VsZC5jb250YWluKCd3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIG5vdCB0aHJvdyBhbiBlcnJvciBpZiB1cmwgZG9lcyBub3QgcmVxdWlyZSBhIHNlc3Npb24gaWQgYW5kIGl0cyBudWxsJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoKTtcbiAgICAgIGxldCBuZXdVcmwgPSBqLmdldFVybEZvclByb3h5KCcvd2QvaHViL3N0YXR1cycpO1xuXG4gICAgICBzaG91bGQuZXhpc3QobmV3VXJsKTtcbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdzdHJhaWdodCBwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBwcm94eSBzdHJhaWdodCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgW3JlcywgYm9keV0gPSBhd2FpdCBqLnByb3h5KCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgICBib2R5LnNob3VsZC5lcWwoe3N0YXR1czogMCwgdmFsdWU6IHtmb286ICdiYXInfX0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcGFzcyBhbG9uZyByZXF1ZXN0IGVycm9ycycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KHtzZXNzaW9uSWQ6ICcxMjMnfSk7XG4gICAgICBqLnByb3h5KCcvYmFkdXJsJywgJ0dFVCcpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgnQ291bGQgbm90IHByb3h5Jyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwcm94eSBlcnJvciByZXNwb25zZXMgYW5kIGNvZGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBbcmVzLCBib2R5XSA9IGF3YWl0IGoucHJveHkoJy9lbGVtZW50L2JhZC90ZXh0JywgJ0dFVCcpO1xuICAgICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDUwMCk7XG4gICAgICBib2R5LnNob3VsZC5lcWwoe3N0YXR1czogMTEsIHZhbHVlOiB7bWVzc2FnZTogJ0ludmlzaWJsZSBlbGVtZW50J319KTtcbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKCdjb21tYW5kIHByb3h5JywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IHByb3h5IGNvbW1hbmQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSgpO1xuICAgICAgbGV0IHJlcyA9IGF3YWl0IGouY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIHJlcy5zaG91bGQuZXFsKHtmb286ICdiYXInfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBwYXNzIGFsb25nIHJlcXVlc3QgZXJyb3JzJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGouY29tbWFuZCgnL2JhZHVybCcsICdHRVQnKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoJ0NvdWxkIG5vdCBwcm94eScpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgd2hlbiBhIGNvbW1hbmQgZmFpbHMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IGUgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgai5jb21tYW5kKCcvZWxlbWVudC9iYWQvdGV4dCcsICdHRVQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlID0gZXJyO1xuICAgICAgfVxuICAgICAgc2hvdWxkLmV4aXN0KGUpO1xuICAgICAgZS5tZXNzYWdlLnNob3VsZC5jb250YWluKCdJbnZpc2libGUgZWxlbWVudCcpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdGhyb3cgd2hlbiBhIGNvbW1hbmQgZmFpbHMgd2l0aCBhIDIwMCBiZWNhdXNlIHRoZSBzdGF0dXMgaXMgbm90IDAnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IGUgPSBudWxsO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgai5jb21tYW5kKCcvZWxlbWVudC8yMDAvdGV4dCcsICdHRVQnKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlID0gZXJyO1xuICAgICAgfVxuICAgICAgc2hvdWxkLmV4aXN0KGUpO1xuICAgICAgZS5lcnJvci5zaG91bGQuZXFsKCdlbGVtZW50IG5vdCB2aXNpYmxlJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyB3aGVuIGEgY29tbWFuZCBmYWlscyB3aXRoIGEgMTAwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBlID0gbnVsbDtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGouY29tbWFuZCgnL3Nlc3Npb24vYmFkY2hyb21lL25vY2hyb21lJywgJ0dFVCcpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGUgPSBlcnI7XG4gICAgICB9XG4gICAgICBzaG91bGQuZXhpc3QoZSk7XG4gICAgICBlLm1lc3NhZ2Uuc2hvdWxkLmNvbnRhaW4oJ2Nocm9tZSBub3QgcmVhY2hhYmxlJyk7XG4gICAgfSk7XG4gIH0pO1xuICBkZXNjcmliZSgncmVxL3JlcyBwcm94eScsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBwcm94eSB2aWEgcmVxIGFuZCBzZW5kIHRvIHJlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBqID0gbW9ja1Byb3h5KCk7XG4gICAgICBsZXQgW3JlcSwgcmVzXSA9IGJ1aWxkUmVxUmVzKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuaGVhZGVyc1snY29udGVudC10eXBlJ10uc2hvdWxkLmVxdWFsKCdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04Jyk7XG4gICAgICByZXMuc2VudENvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7c3RhdHVzOiAwLCB2YWx1ZToge2ZvbzogJ2Jhcid9fSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCByZXdyaXRlIHRoZSBpbm5lciBzZXNzaW9uIGlkIHNvIGl0IGRvZXNudCBjaGFuZ2UnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IFtyZXEsIHJlc10gPSBidWlsZFJlcVJlcygnL2VsZW1lbnQvMjAwL3ZhbHVlJywgJ0dFVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7c3RhdHVzOiAwLCB2YWx1ZTogJ2Zvb2JhcicsIHNlc3Npb25JZDogJzEyMyd9KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJld3JpdGUgdGhlIGlubmVyIHNlc3Npb24gaWQgd2l0aCBzZXNzaW9uSWQgaW4gdXJsJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGogPSBtb2NrUHJveHkoe3Nlc3Npb25JZDogJzEyMyd9KTtcbiAgICAgIGxldCBbcmVxLCByZXNdID0gYnVpbGRSZXFSZXMoJy93ZC9odWIvc2Vzc2lvbi80NTYvZWxlbWVudC8yMDAvdmFsdWUnLCAnUE9TVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7c3RhdHVzOiAwLCB2YWx1ZTogJ2Zvb2JhcicsIHNlc3Npb25JZDogJzQ1Nid9KTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHBhc3MgdGhyb3VnaCB1cmxzIHRoYXQgZG8gbm90IHJlcXVpcmUgc2Vzc2lvbiBJRHMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IFtyZXEsIHJlc10gPSBidWlsZFJlcVJlcygnL3dkL2h1Yi9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICBhd2FpdCBqLnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgICAgIHJlcy5zZW50Qm9keS5zaG91bGQuZXFsKHtzdGF0dXM6IDAsIHZhbHVlOiB7J2Zvbyc6ICdiYXInfX0pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgcHJveHkgc3RyYW5nZSByZXNwb25zZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaiA9IG1vY2tQcm94eSh7c2Vzc2lvbklkOiAnMTIzJ30pO1xuICAgICAgbGV0IFtyZXEsIHJlc10gPSBidWlsZFJlcVJlcygnL25vY2hyb21lJywgJ0dFVCcpO1xuICAgICAgYXdhaXQgai5wcm94eVJlcVJlcyhyZXEsIHJlcyk7XG4gICAgICByZXMuc2VudENvZGUuc2hvdWxkLmVxdWFsKDEwMCk7XG4gICAgICByZXMuc2VudEJvZHkuc2hvdWxkLmVxbCh7c3RhdHVzOiAwLCB2YWx1ZToge21lc3NhZ2U6ICdjaHJvbWUgbm90IHJlYWNoYWJsZSd9fSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwiZmlsZSI6InRlc3QvanNvbndwLXByb3h5L3Byb3h5LXNwZWNzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
