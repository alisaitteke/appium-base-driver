"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _capabilities = require("../capabilities");

let commands = {};

commands.createSession = async function createSession(jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
  if (this.sessionId !== null) {
    throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
  }

  _logger.default.debug();

  let caps;

  if (w3cCapabilities) {
    this.setProtocolW3C();

    if (jsonwpDesiredCapabilities) {
      _logger.default.debug(`W3C capabilities and MJSONWP desired capabilities were provided`);
    }

    if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
      if (!_lodash.default.isEmpty(w3cCapabilities)) {
        _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
      }

      _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

      this.setProtocolMJSONWP();
      caps = jsonwpDesiredCapabilities;
    } else {
      _logger.default.debug(`Creating session with W3C capabilities: ${JSON.stringify(w3cCapabilities, null, 2)}`);

      caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
    }
  } else {
    this.setProtocolMJSONWP();

    _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${JSON.stringify(jsonwpDesiredCapabilities, null, 2)}`);

    caps = jsonwpDesiredCapabilities || {};
  }

  caps = fixCaps(caps, this.desiredCapConstraints);
  this.validateDesiredCaps(caps);
  this.sessionId = _uuidJs.default.create().hex;
  this.caps = caps;
  this.opts = _lodash.default.cloneDeep(this.initialOpts);
  Object.assign(this.opts, this.caps);

  if (this.opts.noReset && this.opts.fullReset) {
    throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + 'exclusive and should not both be set to true. You ' + "probably meant to just use 'fullReset' on its own");
  }

  if (this.opts.noReset === true) {
    this.opts.fullReset = false;
  }

  if (this.opts.fullReset === true) {
    this.opts.noReset = false;
  }

  this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
  this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

  if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
    this.opts.app = null;
  }

  if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
    this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
  }

  this.resetOnUnexpectedShutdown();

  _logger.default.info(`Session created with session id: ${this.sessionId}`);

  let updateUrl = this.caps['statusUpdateUrl'];

  if (updateUrl) {
    try {
      let response = await _requestPromise.default.post({
        url: updateUrl,
        timeout: 2500,
        json: {
          sessionId: this.sessionId,
          action: 'create'
        }
      });

      _logger.default.info('notification sended to ' + updateUrl);
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  return [this.sessionId, caps];
};

commands.getSessions = async function getSessions() {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
};

commands.getSession = async function getSession() {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
};

commands.deleteSession = async function deleteSession() {
  let updateUrl = this.caps['statusUpdateUrl'];

  if (updateUrl) {
    try {
      let response = await _requestPromise.default.post({
        url: updateUrl,
        timeout: 2500,
        json: {
          sessionId: this.sessionId,
          action: 'delete'
        }
      });

      _logger.default.info('notification sended to ' + updateUrl);
    } catch (e) {
      _logger.default.debug(`No obsolete sessions have been detected (${e.message})`);
    }
  }

  this.clearNewCommandTimeout();
  this.sessionId = null;
};

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  for (let cap of booleanCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value)) {
      value = value.toLowerCase();

      if (value === 'true' || value === 'false') {
        _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

        caps[cap] = value === 'true';
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  for (let cap of intCaps) {
    let value = originalCaps[cap];

    if (_lodash.default.isString(value) && !isNaN(value)) {
      value = value.trim();
      let newValue = parseInt(value, 10);

      if (value !== `${newValue}`) {
        newValue = parseFloat(value);
      }

      _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

      caps[cap] = newValue;
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0UHJvdG9jb2xNSlNPTldQIiwiZGVzaXJlZENhcENvbnN0cmFpbnRzIiwic2hvdWxkVmFsaWRhdGVDYXBzIiwiZml4Q2FwcyIsInZhbGlkYXRlRGVzaXJlZENhcHMiLCJVVUlEIiwiY3JlYXRlIiwiaGV4Iiwib3B0cyIsImNsb25lRGVlcCIsImluaXRpYWxPcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwibm9SZXNldCIsImZ1bGxSZXNldCIsIkVycm9yIiwiZmFzdFJlc2V0Iiwic2tpcFVuaW5zdGFsbCIsImFwcCIsInRyaW0iLCJpc1VuZGVmaW5lZCIsIm5ld0NvbW1hbmRUaW1lb3V0IiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsInJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24iLCJpbmZvIiwidXBkYXRlVXJsIiwicmVzcG9uc2UiLCJyZXF1ZXN0IiwicG9zdCIsInVybCIsInRpbWVvdXQiLCJqc29uIiwiYWN0aW9uIiwiZSIsIm1lc3NhZ2UiLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsIm9yaWdpbmFsQ2FwcyIsImNsb25lIiwiYm9vbGVhbkNhcHMiLCJrZXlzIiwicGlja0J5IiwiayIsImlzQm9vbGVhbiIsImNhcCIsInZhbHVlIiwiaXNTdHJpbmciLCJ0b0xvd2VyQ2FzZSIsImludENhcHMiLCJpc051bWJlciIsImlzTmFOIiwibmV3VmFsdWUiLCJwYXJzZUludCIsInBhcnNlRmxvYXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7O0FBRUFBLFFBQVEsQ0FBQ0MsYUFBVCxHQUF5QixlQUFlQSxhQUFmLENBQTZCQyx5QkFBN0IsRUFBd0RDLGtCQUF4RCxFQUE0RUMsZUFBNUUsRUFBNkY7QUFDbEgsTUFBSSxLQUFLQyxTQUFMLEtBQW1CLElBQXZCLEVBQTZCO0FBQ3pCLFVBQU0sSUFBSUMsaUJBQU9DLHNCQUFYLENBQWtDLGlDQUNwQywwQkFERSxDQUFOO0FBRUg7O0FBRURDLGtCQUFJQyxLQUFKOztBQUdBLE1BQUlDLElBQUo7O0FBQ0EsTUFBSU4sZUFBSixFQUFxQjtBQUNqQixTQUFLTyxjQUFMOztBQUNBLFFBQUlULHlCQUFKLEVBQStCO0FBQzNCTSxzQkFBSUMsS0FBSixDQUFXLGlFQUFYO0FBQ0g7O0FBRUQsUUFBSVAseUJBQXlCLElBQUksQ0FBQ1UsZ0JBQUVDLGFBQUYsQ0FBZ0JULGVBQWhCLENBQWxDLEVBQW9FO0FBR2hFLFVBQUksQ0FBQ1EsZ0JBQUVFLE9BQUYsQ0FBVVYsZUFBVixDQUFMLEVBQWlDO0FBQzdCSSx3QkFBSU8sSUFBSixDQUFVLDBFQUF5RUMsSUFBSSxDQUFDQyxTQUFMLENBQWViLGVBQWYsQ0FBZ0MsRUFBbkg7QUFDSDs7QUFDREksc0JBQUlPLElBQUosQ0FBVSw4Q0FBVjs7QUFDQSxXQUFLRyxrQkFBTDtBQUNBUixNQUFBQSxJQUFJLEdBQUdSLHlCQUFQO0FBQ0gsS0FURCxNQVNPO0FBQ0hNLHNCQUFJQyxLQUFKLENBQVcsMkNBQTBDTyxJQUFJLENBQUNDLFNBQUwsQ0FBZWIsZUFBZixFQUFnQyxJQUFoQyxF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aUNrRCxDQUFELElBQU9BLENBQUMsQ0FBQ08sUUFBRixLQUFlLElBQXRELENBQVAsQ0FBZDs7QUFDQSxPQUFLLElBQUlMLEdBQVQsSUFBZ0JJLE9BQWhCLEVBQXlCO0FBQ3JCLFFBQUlILEtBQUssR0FBR1IsWUFBWSxDQUFDTyxHQUFELENBQXhCOztBQUNBLFFBQUkzRCxnQkFBRTZELFFBQUYsQ0FBV0QsS0FBWCxLQUFxQixDQUFDSyxLQUFLLENBQUNMLEtBQUQsQ0FBL0IsRUFBd0M7QUFDcENBLE1BQUFBLEtBQUssR0FBR0EsS0FBSyxDQUFDbkMsSUFBTixFQUFSO0FBQ0EsVUFBSXlDLFFBQVEsR0FBR0MsUUFBUSxDQUFDUCxLQUFELEVBQVEsRUFBUixDQUF2Qjs7QUFDQSxVQUFJQSxLQUFLLEtBQU0sR0FBRU0sUUFBUyxFQUExQixFQUE2QjtBQUN6QkEsUUFBQUEsUUFBUSxHQUFHRSxVQUFVLENBQUNSLEtBQUQsQ0FBckI7QUFDSDs7QUFDRGhFLHNCQUFJTyxJQUFKLENBQVUsZUFBY3dELEdBQUksMkJBQTBCQyxLQUFNLGtCQUFpQk0sUUFBUyx1Q0FBdEY7O0FBQ0FwRSxNQUFBQSxJQUFJLENBQUM2RCxHQUFELENBQUosR0FBWU8sUUFBWjtBQUNIO0FBQ0o7O0FBRUQsU0FBT3BFLElBQVA7QUFDSDs7ZUFFY1YsUSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHJlcXVpcmUtYXdhaXQgKi9cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHtlcnJvcnN9IGZyb20gJy4uLy4uL3Byb3RvY29sJztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IHtwcm9jZXNzQ2FwYWJpbGl0aWVzfSBmcm9tICcuLi9jYXBhYmlsaXRpZXMnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuY3JlYXRlU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVNlc3Npb24oanNvbndwRGVzaXJlZENhcGFiaWxpdGllcywganNvbndwUmVxdWlyZWRDYXBzLCB3M2NDYXBhYmlsaXRpZXMpIHtcbiAgICBpZiAodGhpcy5zZXNzaW9uSWQgIT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKCdDYW5ub3QgY3JlYXRlIGEgbmV3IHNlc3Npb24gJyArXG4gICAgICAgICAgICAnd2hpbGUgb25lIGlzIGluIHByb2dyZXNzJyk7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKCk7XG5cbiAgICAvLyBEZXRlcm1pbmUgd2VhdGhlciB3ZSBzaG91bGQgdXNlIGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgb3IgdzNjQ2FwYWJpbGl0aWVzIHRvIGdldCBjYXBzIGZyb21cbiAgICBsZXQgY2FwcztcbiAgICBpZiAodzNjQ2FwYWJpbGl0aWVzKSB7XG4gICAgICAgIHRoaXMuc2V0UHJvdG9jb2xXM0MoKTtcbiAgICAgICAgaWYgKGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgVzNDIGNhcGFiaWxpdGllcyBhbmQgTUpTT05XUCBkZXNpcmVkIGNhcGFiaWxpdGllcyB3ZXJlIHByb3ZpZGVkYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcyAmJiAhXy5pc1BsYWluT2JqZWN0KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgICAgICAgIC8vIElmIFczQyBDYXBhYmlsaXRpZXMgYW5kIE1KU09OV1AgQ2FwYWJpbGl0aWVzIHdlcmUgcHJvdmlkZWQgYW5kIFczQyBjYXBzIGFyZW4ndCBhIHBsYWluIG9iamVjdCxcbiAgICAgICAgICAgIC8vIGxvZyBhIHdhcm5pbmcgYW5kIGZhbGwgYmFjayB0byBNSlNPTldQXG4gICAgICAgICAgICBpZiAoIV8uaXNFbXB0eSh3M2NDYXBhYmlsaXRpZXMpKSB7XG4gICAgICAgICAgICAgICAgbG9nLndhcm4oYEV4cGVjdGVkIFczQyBcImNhcGFiaWxpdGllc1wiIHRvIGJlIGEgSlNPTiBPYmplY3QgYnV0IHdhcyBwcm92aWRlZCB3aXRoOiAke0pTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcyl9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsb2cud2FybihgRmFsbGluZyBiYWNrIHRvIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXNgKTtcbiAgICAgICAgICAgIHRoaXMuc2V0UHJvdG9jb2xNSlNPTldQKCk7XG4gICAgICAgICAgICBjYXBzID0ganNvbndwRGVzaXJlZENhcGFiaWxpdGllcztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIFczQyBjYXBhYmlsaXRpZXM6ICR7SlNPTi5zdHJpbmdpZnkodzNjQ2FwYWJpbGl0aWVzLCBudWxsLCAyKX1gKTtcbiAgICAgICAgICAgIGNhcHMgPSBwcm9jZXNzQ2FwYWJpbGl0aWVzKHczY0NhcGFiaWxpdGllcywgdGhpcy5kZXNpcmVkQ2FwQ29uc3RyYWludHMsIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2V0UHJvdG9jb2xNSlNPTldQKCk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXM6ICR7SlNPTi5zdHJpbmdpZnkoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcywgbnVsbCwgMil9YCk7XG4gICAgICAgIGNhcHMgPSBqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzIHx8IHt9O1xuICAgIH1cblxuICAgIGNhcHMgPSBmaXhDYXBzKGNhcHMsIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzKTtcbiAgICB0aGlzLnZhbGlkYXRlRGVzaXJlZENhcHMoY2Fwcyk7XG5cbiAgICB0aGlzLnNlc3Npb25JZCA9IFVVSUQuY3JlYXRlKCkuaGV4O1xuICAgIHRoaXMuY2FwcyA9IGNhcHM7XG4gICAgdGhpcy5vcHRzID0gXy5jbG9uZURlZXAodGhpcy5pbml0aWFsT3B0cyk7XG5cbiAgICAvLyBtZXJnZSBjYXBzIG9udG8gb3B0cyBzbyB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHdoYXQncyB3aGVyZVxuICAgIE9iamVjdC5hc3NpZ24odGhpcy5vcHRzLCB0aGlzLmNhcHMpO1xuXG4gICAgLy8gZGVhbCB3aXRoIHJlc2V0c1xuICAgIC8vIHNvbWUgcGVvcGxlIGxpa2UgdG8gZG8gd2VpcmQgdGhpbmdzIGJ5IHNldHRpbmcgbm9SZXNldCBhbmQgZnVsbFJlc2V0XG4gICAgLy8gYm90aCB0byB0cnVlLCBidXQgdGhpcyBpcyBtaXNndWlkZWQgYW5kIHN0cmFuZ2UsIHNvIGVycm9yIGhlcmUgaW5zdGVhZFxuICAgIGlmICh0aGlzLm9wdHMubm9SZXNldCAmJiB0aGlzLm9wdHMuZnVsbFJlc2V0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRoZSAnbm9SZXNldCcgYW5kICdmdWxsUmVzZXQnIGNhcGFiaWxpdGllcyBhcmUgbXV0dWFsbHkgXCIgK1xuICAgICAgICAgICAgJ2V4Y2x1c2l2ZSBhbmQgc2hvdWxkIG5vdCBib3RoIGJlIHNldCB0byB0cnVlLiBZb3UgJyArXG4gICAgICAgICAgICBcInByb2JhYmx5IG1lYW50IHRvIGp1c3QgdXNlICdmdWxsUmVzZXQnIG9uIGl0cyBvd25cIik7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdHMubm9SZXNldCA9PT0gdHJ1ZSkge1xuICAgICAgICB0aGlzLm9wdHMuZnVsbFJlc2V0ID0gZmFsc2U7XG4gICAgfVxuICAgIGlmICh0aGlzLm9wdHMuZnVsbFJlc2V0ID09PSB0cnVlKSB7XG4gICAgICAgIHRoaXMub3B0cy5ub1Jlc2V0ID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMub3B0cy5mYXN0UmVzZXQgPSAhdGhpcy5vcHRzLmZ1bGxSZXNldCAmJiAhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gICAgdGhpcy5vcHRzLnNraXBVbmluc3RhbGwgPSB0aGlzLm9wdHMuZmFzdFJlc2V0IHx8IHRoaXMub3B0cy5ub1Jlc2V0O1xuXG4gICAgLy8gUHJldmVudHMgZW1wdHkgc3RyaW5nIGNhcHMgc28gd2UgZG9uJ3QgbmVlZCB0byB0ZXN0IGl0IGV2ZXJ5d2hlcmVcbiAgICBpZiAodHlwZW9mIHRoaXMub3B0cy5hcHAgPT09ICdzdHJpbmcnICYmIHRoaXMub3B0cy5hcHAudHJpbSgpID09PSAnJykge1xuICAgICAgICB0aGlzLm9wdHMuYXBwID0gbnVsbDtcbiAgICB9XG5cbiAgICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0KSkge1xuICAgICAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSAodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0ICogMTAwMCk7XG4gICAgfVxuXG4gICAgLy8gV2UgbmVlZCB0byBpbmluaXRpYWxpemUgb25lIG9uVW5leHBlY3RlZFNodXRkb3cgcHJvbWlzZSBwZXIgc2Vzc2lvblxuICAgIC8vIHRvIGF2b2lkIHRoZSBwcm9taXNlIGZ1bGZpbG1lbnQgYmVpbmcgcHJvcGFnYXRlZCBiZXR3ZWVuIHNlc3Npb25zLlxuICAgIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93bigpO1xuXG4gICAgbG9nLmluZm8oYFNlc3Npb24gY3JlYXRlZCB3aXRoIHNlc3Npb24gaWQ6ICR7dGhpcy5zZXNzaW9uSWR9YCk7XG5cbiAgICBsZXQgdXBkYXRlVXJsID0gdGhpcy5jYXBzWydzdGF0dXNVcGRhdGVVcmwnXTtcblxuICAgIGlmICh1cGRhdGVVcmwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QucG9zdCh7XG4gICAgICAgICAgICAgICAgdXJsOiB1cGRhdGVVcmwsXG4gICAgICAgICAgICAgICAgdGltZW91dDogMjUwMCxcbiAgICAgICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2NyZWF0ZSdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsb2cuaW5mbygnbm90aWZpY2F0aW9uIHNlbmRlZCB0byAnICsgdXBkYXRlVXJsKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYE5vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCAoJHtlLm1lc3NhZ2V9KWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIFt0aGlzLnNlc3Npb25JZCwgY2Fwc107XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9ucyA9IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb25zKCkge1xuICAgIGxldCByZXQgPSBbXTtcblxuICAgIGlmICh0aGlzLnNlc3Npb25JZCkge1xuICAgICAgICByZXQucHVzaCh7XG4gICAgICAgICAgICBpZDogdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICBjYXBhYmlsaXRpZXM6IHRoaXMuY2Fwc1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmV0O1xufTtcblxuY29tbWFuZHMuZ2V0U2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIGdldFNlc3Npb24oKSB7XG4gICAgaWYgKHRoaXMuY2Fwcy5ldmVudFRpbWluZ3MpIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY2Fwcywge2V2ZW50czogdGhpcy5ldmVudEhpc3Rvcnl9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY2Fwcztcbn07XG5cbmNvbW1hbmRzLmRlbGV0ZVNlc3Npb24gPSBhc3luYyBmdW5jdGlvbiBkZWxldGVTZXNzaW9uKC8qIHNlc3Npb25JZCAqLykge1xuICAgIGxldCB1cGRhdGVVcmwgPSB0aGlzLmNhcHNbJ3N0YXR1c1VwZGF0ZVVybCddO1xuICAgIGlmICh1cGRhdGVVcmwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QucG9zdCh7XG4gICAgICAgICAgICAgICAgdXJsOiB1cGRhdGVVcmwsXG4gICAgICAgICAgICAgICAgdGltZW91dDogMjUwMCxcbiAgICAgICAgICAgICAgICBqc29uOiB7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25JZDogdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2RlbGV0ZSdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBsb2cuaW5mbygnbm90aWZpY2F0aW9uIHNlbmRlZCB0byAnICsgdXBkYXRlVXJsKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYE5vIG9ic29sZXRlIHNlc3Npb25zIGhhdmUgYmVlbiBkZXRlY3RlZCAoJHtlLm1lc3NhZ2V9KWApO1xuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgICB0aGlzLnNlc3Npb25JZCA9IG51bGw7XG59O1xuXG5mdW5jdGlvbiBmaXhDYXBzKG9yaWdpbmFsQ2FwcywgZGVzaXJlZENhcENvbnN0cmFpbnRzID0ge30pIHtcbiAgICBsZXQgY2FwcyA9IF8uY2xvbmUob3JpZ2luYWxDYXBzKTtcblxuICAgIC8vIGJvb2xlYW4gY2FwYWJpbGl0aWVzIGNhbiBiZSBwYXNzZWQgaW4gYXMgc3RyaW5ncyAnZmFsc2UnIGFuZCAndHJ1ZSdcbiAgICAvLyB3aGljaCB3ZSB3YW50IHRvIHRyYW5zbGF0ZSBpbnRvIGJvb2xlYW4gdmFsdWVzXG4gICAgbGV0IGJvb2xlYW5DYXBzID0gXy5rZXlzKF8ucGlja0J5KGRlc2lyZWRDYXBDb25zdHJhaW50cywgKGspID0+IGsuaXNCb29sZWFuID09PSB0cnVlKSk7XG4gICAgZm9yIChsZXQgY2FwIG9mIGJvb2xlYW5DYXBzKSB7XG4gICAgICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsQ2Fwc1tjYXBdO1xuICAgICAgICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gJ3RydWUnIHx8IHZhbHVlID09PSAnZmFsc2UnKSB7XG4gICAgICAgICAgICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyB0byBib29sZWFuLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICAgICAgICAgICAgY2Fwc1tjYXBdID0gKHZhbHVlID09PSAndHJ1ZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gaW50IGNhcGFiaWxpdGllcyBhcmUgb2Z0ZW4gc2VudCBpbiBhcyBzdHJpbmdzIGJ5IGZyYW1ld29ya3NcbiAgICBsZXQgaW50Q2FwcyA9IF8ua2V5cyhfLnBpY2tCeShkZXNpcmVkQ2FwQ29uc3RyYWludHMsIChrKSA9PiBrLmlzTnVtYmVyID09PSB0cnVlKSk7XG4gICAgZm9yIChsZXQgY2FwIG9mIGludENhcHMpIHtcbiAgICAgICAgbGV0IHZhbHVlID0gb3JpZ2luYWxDYXBzW2NhcF07XG4gICAgICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSAmJiAhaXNOYU4odmFsdWUpKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRyaW0oKTtcbiAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IGAke25ld1ZhbHVlfWApIHtcbiAgICAgICAgICAgICAgICBuZXdWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbG9nLndhcm4oYENhcGFiaWxpdHkgJyR7Y2FwfScgY2hhbmdlZCBmcm9tIHN0cmluZyAoJyR7dmFsdWV9JykgdG8gaW50ZWdlciAoJHtuZXdWYWx1ZX0pLiBUaGlzIG1heSBjYXVzZSB1bmV4cGVjdGVkIGJlaGF2aW9yYCk7XG4gICAgICAgICAgICBjYXBzW2NhcF0gPSBuZXdWYWx1ZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjYXBzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2Jhc2Vkcml2ZXIvY29tbWFuZHMvc2Vzc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLiJ9
